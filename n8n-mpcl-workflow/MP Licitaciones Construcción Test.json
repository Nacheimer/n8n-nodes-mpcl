{
  "name": "MP Licitaciones Analysis",
  "nodes": [
    {
      "parameters": {},
      "id": "5c210a8a-a52d-4089-b829-e641ad098848",
      "name": "When clicking 'Execute workflow'",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1040,
        -128
      ]
    },
    {
      "parameters": {
        "content": "## üìã Valores V√°lidos para Campo SECTOR\n\nEn el nodo \"Set Client Data\", el campo **sector** acepta los siguientes valores:\n\n- `agricultura_materias_primas`\n- `metales_aleaciones`\n- `quimicos`\n- `caucho_resinas`\n- `papel`\n- `combustibles`\n- `mineria`\n- `maquinaria_agricola`\n- `maquinaria_industrial`\n- `maquinaria_servicios`\n- `software`\n- `salud`\n- `construccion`\n- `transporte`\n- `materiales_construccion`\n- `vehiculos_transporte`\n- `componentes_electricos`\n\n**Importante**: Escribir el valor exacto (copiar/pegar)",
        "height": 464,
        "width": 391,
        "color": 4
      },
      "id": "sticky-note-sector-help",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1280,
        -320
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bed8d402-8f6a-4062-953a-7ced913ec339",
              "name": "companyName",
              "value": "Construcci√≥n Test",
              "type": "string"
            },
            {
              "id": "4c2e5ff9-3d76-4cd7-a0b6-ef8a39bdb4b2",
              "name": "companyEmail",
              "value": "eduardomellaramirez@gmail.com",
              "type": "string"
            },
            {
              "id": "3a274f29-c85f-4636-9f1f-a054b3e3b9b5",
              "name": "sector",
              "value": "construccion",
              "type": "string"
            },
            {
              "id": "3a274f29-c85f-4636-9f1f-a054b3e3b9b6",
              "name": "tags",
              "value": "construcci√≥n de obras p√∫blicas,hospitales,edificaci√≥n,infraestructura,obras civiles,mantenimiento,arquitectura,urbanizaci√≥n,caminos,licitaciones construcci√≥n",
              "type": "string"
            },
            {
              "id": "38e1da9d-0e09-4f69-ab3b-4860e0e56cbf",
              "name": "ruburos",
              "value": "72131700, 30222400, 30222700",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "57cc3d99-884a-4aba-b2b0-dbcd63cb0d54",
      "name": "Set Client Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -896,
        -128
      ]
    },
    {
      "parameters": {
        "operation": "webSearch",
        "idOrden": 3,
        "rubros": "={{ $json.rubros }}"
      },
      "id": "eaecee26-0b68-431f-a1a2-86cc451afb86",
      "name": "Search Tenders",
      "type": "n8n-nodes-mpcl.mercadoPublico",
      "typeVersion": 1,
      "position": [
        -608,
        -128
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Format tender data for LLM analysis\nconst items = $input.all();\n\nconsole.log('=== FORMAT TENDERS FOR LLM ===');\nconsole.log('Items received from Search Tenders:', items.length);\n\nif (!items || items.length === 0) {\n  console.warn('WARNING: No items received from Search Tenders');\n  return [{ json: { \n    count: 0,\n    tenders: [],\n    markdown: '',\n    hasData: false\n  }}];\n}\n\nif (items.length > 0) {\n  console.log('First item keys:', Object.keys(items[0].json));\n  console.log('First item sample:', JSON.stringify(items[0].json, null, 2).substring(0, 500));\n}\n\nconst formattedTenders = items.map((item, index) => {\n  const t = item.json;\n\n  let montoValue = 0;\n  if (t.monto) {\n    if (typeof t.monto === 'string') {\n      montoValue = parseInt(t.monto.replace(/\\./g, ''), 10) || 0;\n    } else {\n      montoValue = t.monto;\n    }\n  }\n\n  return {\n    numero: index + 1,\n    codigo: t.id || 'N/A',\n    nombre: t.title || 'Sin t√≠tulo',\n    descripcion: t.description || 'Sin descripci√≥n',\n    monto_estimado: montoValue,\n    fecha_publicacion: t.fechaPublicacion || 'N/A',\n    fecha_cierre: t.fechaCierre || 'N/A',\n    tipo: t.tipo || 'N/A',\n    estado: t.estado || 'N/A',\n    organismo: t.organismo || 'N/A',\n    link: t.link || ''\n  };\n});\n\nconsole.log('Formatted tenders count:', formattedTenders.length);\nconsole.log('First formatted tender:', formattedTenders[0]);\n\n// Generate Markdown string for the LLM (truncate descriptions to 400 chars)\nconst markdown = formattedTenders.map(t => `\n---\nC√ìDIGO: ${t.codigo}\nNOMBRE: ${t.nombre}\nDESCRIPCI√ìN: ${t.descripcion.substring(0,400)}...\n`).join('');\n\nreturn [{\n  json: {\n    count: formattedTenders.length,\n    tenders: formattedTenders,\n    markdown: markdown,\n    hasData: true\n  }\n}];"
      },
      "id": "71729e55-e690-4b71-a466-09e8cb526663",
      "name": "Format Tenders for LLM",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        -128
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4-turbo",
          "mode": "list",
          "cachedResultName": "gpt-4-turbo"
        },
        "messages": {
          "values": [
            {
              "content": "Eres un experto en an√°lisis de licitaciones p√∫blicas. Tu tarea es identificar qu√© licitaciones son relevantes para un cliente bas√°ndote en sus palabras clave de inter√©s.\n\nüìã INSTRUCCIONES:\n\n1. ANALIZAR las palabras clave del cliente (pueden estar separadas por comas o espacios)\n2. REVISAR cada licitaci√≥n en la lista buscando coincidencias en NOMBRE y DESCRIPCI√ìN\n3. ACEPTAR coincidencias directas Y sem√°nticas:\n   - Palabras exactas\n   - Sin√≥nimos y t√©rminos relacionados del sector\n   - Variaciones ortogr√°ficas\n\n4. Para CADA licitaci√≥n relevante:\n   - COPIAR su c√≥digo EXACTAMENTE como aparece despu√©s de \"C√ìDIGO:\"\n   - M√°ximo 10 licitaciones\n\n5. Si NO encuentras licitaciones relevantes ‚Üí devolver {\"matching_ids\": []}\n\n‚ö†Ô∏è IMPORTANTE: \n- SOLO devuelve c√≥digos que aparezcan LITERALMENTE en la lista proporcionada\n- NUNCA inventes c√≥digos nuevos\n- Los c√≥digos tienen formato como \"2735-144-LR25\", \"425-90-LQ25\", etc.\n- S√â INCLUSIVO: acepta sin√≥nimos, t√©rminos relacionados y variaciones del sector\n\nRESPUESTA (formato JSON):\n{\n  \"matching_ids\": [\"codigo-1\", \"codigo-2\", ...]\n}",
              "role": "system"
            },
            {
              "content": "={{ $('Set Client Data').item.json.sector === 'agricultura_materias_primas' ? 'üìö SECTOR: AGRICULTURA Y MATERIAS PRIMAS\\n\\nSin√≥nimos clave:\\n- agricultura = agr√≠cola = agropecuario = cultivo = producci√≥n agr√≠cola = explotaci√≥n agr√≠cola\\n- ganader√≠a = ganado = pecuario = crianza = producci√≥n animal = explotaci√≥n ganadera\\n- materias primas = insumos agr√≠colas = productos agr√≠colas = recursos naturales\\n\\nT√©rminos aceptados del cat√°logo oficial:\\n- Animales: ganado, aves de corral, peces, animales dom√©sticos, animales salvajes, insectos, mariscos, moluscos, crust√°ceos, mascotas\\n- Alimentos para animales: alimento para ganado, aves, peces, perros, gatos, roedores, reptiles\\n- Plantas y cultivos: √°rboles, arbustos, flores, plantas con flor, plantas sin flor, productos vegetales, semillas, alm√°cigos, bulbos, tallos\\n- Semillas: cereales, hierbas, forraje, especias, flores, cultivos fibrosos, semilleros\\n- Insumos agr√≠colas: abonos org√°nicos, abonos qu√≠micos, fertilizantes, pesticidas, herbicidas, repelentes de plagas, dispositivos para control de plagas\\n- Infraestructura animal: cobertizos, refugios, h√°bitats para animales, art√≠culos de talabarter√≠a, arneses\\n- Residuos: residuos vegetales no alimentarios\\n- Servicios: administraci√≥n agr√≠cola, estudios de suelos y cultivos, econom√≠a agraria, catastros, derechos de aguas\\n- Veterinaria: accesorios y tratamientos para mascotas, productos veterinarios\\n\\nRubros espec√≠ficos identificados:\\n- 10101500: Animales dom√©sticos\\n- 10121500: Alimento para ganado\\n- 10161500: √Årboles y arbustos\\n- 10171500: Abonos org√°nicos\\n- 10171600: Abonos qu√≠micos\\n- 10171700: Herbicidas\\n- 10191500: Pesticidas o repelentes de plagas\\n- 10151500: Semillas y alm√°cigos' : $('Set Client Data').item.json.sector === 'metales_aleaciones' ? 'üìö SECTOR: METALES, ALEACIONES Y MATERIAS PRIMAS INDUSTRIALES\\n\\nSin√≥nimos clave:\\n- metales = metal = aleaci√≥n = aleaciones = metal√∫rgico = sider√∫rgico\\n- acero = aceros = acer√≠a = productos sider√∫rgicos = estructuras met√°licas\\n- minerales = mineral = miner√≠a = materias primas = recursos mineros = extracci√≥n\\n\\nT√©rminos aceptados del cat√°logo oficial:\\n- Aceros: aceros b√°sicos, aceros r√°pidos, aceros especiales, estructuras de acero\\n- Metales base: hierro, aluminio, cobre, zinc, plomo, esta√±o, n√≠quel\\n- Metales preciosos: oro, plata, platino, paladio\\n- Aleaciones: aleaciones ferrosas, aleaciones no ferrosas, bronces, latones\\n- Minerales: minerales met√°licos, minerales no met√°licos, tierras y suelos\\n- Productos met√°licos: barras, perfiles, chapas, l√°minas, tubos, ca√±er√≠as met√°licas\\n- Materias primas: cuero, pieles, subproductos animales, tejidos naturales\\n- Textiles: tejidos de algod√≥n, tejidos de seda, tejidos sint√©ticos, tejidos vegetales, tejidos especiales, telas no tejidas\\n- Desperdicios: desechos met√°licos, desechos no met√°licos, desperdicios org√°nicos, chatarra, reciclaje de metales\\n- Cuerpos s√≥lidos: lingotes, bloques, tochos, barras, perfiles estructurales\\n\\nRubros espec√≠ficos identificados:\\n- 11171500: Aceros b√°sicos\\n- 11171700: Aceros r√°pidos\\n- 11101600: Metales\\n- 11101700: Metales base\\n- 11101800: Metales preciosos\\n- 11101500: Minerales\\n- 11191500: Cuerpos s√≥lidos de metal\\n- 11141600: Desechos no met√°licos\\n- 11141700: Desperdicios org√°nicos y de tabaco\\n- 11131500: Cuero, pieles y subproductos animales' : $('Set Client Data').item.json.sector === 'quimicos' ? 'üìö SECTOR: QU√çMICOS Y PRODUCTOS QU√çMICOS\\n\\nSin√≥nimos clave:\\n- qu√≠micos = productos qu√≠micos = sustancias qu√≠micas = compuestos qu√≠micos = reactivos\\n- aditivos = aditivos qu√≠micos = aditivos industriales = mejoradores = estabilizadores\\n- explosivos = pirotecnia = materiales explosivos = p√≥lvoras = detonantes\\n\\nT√©rminos aceptados del cat√°logo oficial:\\n- Aceites: aceites industriales, aceites lubricantes, aceites hidr√°ulicos, aceites sint√©ticos\\n- Aditivos: aditivos para alimentos, aditivos para f√°rmacos, aditivos para carburante, aditivos para p√©rdida de fluido\\n- Anti-productos: anti-sedimentos, anti-oxidantes, anti-congelantes, anti-corrosivos\\n- Compuestos: compuestos arom√°ticos, compuestos alif√°ticos, compuestos de colores, dispersiones, derivados org√°nicos\\n- Explosivos: explosivos civiles, explosivos militares, p√≥lvoras, detonantes, pirotecnia\\n- Gases: gases industriales, gases comprimidos, gases licuados, gases inertes, gases especiales\\n- Metales qu√≠micos: √≥xido de metales, √≥xido de metales raros, metales alcalinos, metales de transici√≥n\\n- Pinturas: pinturas industriales, recubrimientos, esmaltes, barnices, tintes, colorantes\\n- Productos qu√≠micos: √°cidos, bases, sales, solventes, reactivos, catalizadores\\n- Pol√≠meros: resinas, pl√°sticos, elast√≥meros, pol√≠meros sint√©ticos\\n- Productos de limpieza: detergentes industriales, desinfectantes, limpiadores qu√≠micos\\n- Tratamientos: tratamientos de agua, tratamientos de superficie, agentes de curado\\n\\nRubros espec√≠ficos identificados:\\n- 12181600: Aceites\\n- 12164500: Aditivos para alimentos y f√°rmacos\\n- 12162700: Aditivos para p√©rdida de fluido\\n- 12163100: Anti sedimentos\\n- 12162200: Anti-oxidantes\\n- 12352000: Compuestos arom√°ticos y alif√°ticos\\n- 12171700: Compuestos de colores y dispersiones\\n- 12131500: Explosivos\\n- 12141500: √ìxido de metales\\n- 12141600: √ìxido de metales raros' : $('Set Client Data').item.json.sector === 'software' ? 'üìö SECTOR: SOFTWARE Y TECNOLOG√çA\\n\\nSin√≥nimos clave:\\n- software = licencias = sistemas = aplicaciones = programas = plataformas = soluciones inform√°ticas\\n\\nT√©rminos aceptados del cat√°logo oficial:\\n- Servicios TI: desarrollo, mantenci√≥n, soporte, mantenimiento, implementaci√≥n, consultor√≠a TI, arquitectura de software, integraci√≥n, capacitaci√≥n, asesor√≠a t√©cnica\\n- Productos software: licencias, Microsoft Office, Adobe, VMware, Red Hat, Oracle, SAP, AutoCAD, bases de datos, servidores, antivirus, firewalls\\n- Infraestructura: cloud, ciberseguridad, infraestructura TI, redes, telecomunicaciones, data centers, virtualizaci√≥n, almacenamiento\\n- Desarrollo: ingenier√≠a de software, desarrollo web, desarrollo m√≥vil, apps, portales, sistemas de informaci√≥n, ERP, CRM\\n- Actividades: instalaci√≥n, configuraci√≥n, actualizaci√≥n, migraci√≥n, integraci√≥n, parametrizaci√≥n, puesta en marcha\\n- Hardware relacionado: computadores, servidores, equipamiento inform√°tico, perif√©ricos, impresoras, esc√°neres, monitores\\n- Gesti√≥n: administraci√≥n de sistemas, gesti√≥n de proyectos TI, service desk, mesa de ayuda, soporte t√©cnico\\n- Seguridad: ciberseguridad, seguridad inform√°tica, respaldo, backup, recuperaci√≥n de desastres, protecci√≥n de datos\\n- Comunicaciones: telecomunicaciones, telefon√≠a IP, videoconferencia, redes, conectividad, cableado estructurado\\n\\nRubros espec√≠ficos identificados:\\n- 81111800: Administraci√≥n de sistemas\\n- 81112200: Licenciamiento de software\\n- 43231500: Software de aplicaci√≥n\\n- 43232300: Software de desarrollo\\n- 81141500: Contratistas en tecnolog√≠as de la informaci√≥n\\n- 81101500 - 81102300: Servicios inform√°ticos diversos\\n- 82111500 - 82111700: Telecomunicaciones\\n- 80111800: Consultor√≠as TI' : $('Set Client Data').item.json.sector === 'salud' ? 'üìö SECTOR: SALUD\\n\\nSin√≥nimos clave:\\n- hospital = centro de salud = establecimiento de salud = consultorio = CESFAM = cl√≠nica = servicio de salud = centro m√©dico = centro asistencial\\n\\nT√©rminos aceptados del cat√°logo oficial:\\n- Establecimientos: hospitales, cl√≠nicas, consultorios, CESFAM, SAR, SAPU, centro de salud ambulatoria, policl√≠nicos, postas, unidades de emergencia\\n- Servicios m√©dicos: atenci√≥n m√©dica, prestaciones de salud, servicios cl√≠nicos, atenci√≥n primaria, atenci√≥n secundaria, atenci√≥n terciaria, emergencias, urgencias, telemedicina, teleradiolog√≠a\\n- Equipamiento m√©dico: electrocardi√≥grafo, electrocardi√≥grafo, rayos X, ec√≥grafo, tom√≥grafo, resonador, monitores m√©dicos, desfibrilador, ventilador, camillas, camas cl√≠nicas, instrumental quir√∫rgico\\n- Diagn√≥stico: ex√°menes, laboratorio cl√≠nico, imagenolog√≠a, radiolog√≠a, rayos X, ecograf√≠a, tomograf√≠a, resonancia magn√©tica, electrocardiograf√≠a\\n- Insumos: medicamentos, f√°rmacos, drogas, material cl√≠nico, insumos hospitalarios, dispositivos m√©dicos, jeringas, gasas, vendajes, guantes, mascarillas\\n- Personal: m√©dicos, enfermeras, t√©cnicos param√©dicos, matronas, kinesi√≥logos, nutricionistas, psic√≥logos, terapeutas\\n- Especialidades: medicina interna, cirug√≠a, pediatr√≠a, ginecolog√≠a, obstetricia, traumatolog√≠a, oftalmolog√≠a, cardiolog√≠a, neurolog√≠a\\n- Procedimientos: cirug√≠as, intervenciones, tratamientos, terapias, rehabilitaci√≥n, diagn√≥stico, atenci√≥n, consultas\\n- Servicios de apoyo: aseo hospitalario, alimentaci√≥n hospitalaria, lavander√≠a hospitalaria, esterilizaci√≥n, manejo de residuos hospitalarios\\n- Infraestructura: construcci√≥n hospitales, equipamiento hospitalar, mobiliario cl√≠nico, sistemas de gases medicinales\\n\\nRubros espec√≠ficos identificados:\\n- 42xxxxxx: Instrumental y equipamiento m√©dico\\n- 51xxxxxx: Medicamentos y productos farmac√©uticos\\n- 85101500: Edificaci√≥n de centros de atenci√≥n de salud\\n- 85122200: Evaluaci√≥n de salud\\n- 85131500: Mantenimiento de servicios de salud\\n- 85131600: Mantenimiento hospitalario\\n- 85121600 - 85122200: Servicios cl√≠nicos diversos\\n- 93131700: Limpieza de hospitales y servicios de salud' : $('Set Client Data').item.json.sector === 'construccion' ? 'üìö SECTOR: CONSTRUCCI√ìN E INFRAESTRUCTURA\\n\\nSin√≥nimos clave:\\n- construcci√≥n = edificaci√≥n = obra = ejecuci√≥n = proyecto = levantamiento = desarrollo de obra\\n\\nT√©rminos aceptados del cat√°logo oficial:\\n- Actividades: construcci√≥n, edificaci√≥n, mejoramiento, habilitaci√≥n, reposici√≥n, ampliaci√≥n, remodelaci√≥n, reparaci√≥n, restauraci√≥n, mantenci√≥n, conservaci√≥n, rehabilitaci√≥n, normalizaci√≥n, terminaci√≥n, instalaci√≥n, montaje\\n- Obras civiles: puentes, t√∫neles, viaductos, pasos sobre nivel, pasos bajo nivel, muros de contenci√≥n, defensas fluviales\\n- Vialidad: carreteras, caminos, calles, avenidas, pasajes, veredas, aceras, bermas, ciclov√≠as, pavimentaci√≥n, carpeta asf√°ltica, hormig√≥n, adoquines\\n- Edificaciones: edificios p√∫blicos, colegios, hospitales, consultorios, comisar√≠as, cuarteles, oficinas, sedes sociales, gimnasios, estadios, multicanchas\\n- Infraestructura deportiva: estadios, gimnasios, multicanchas, canchas, piscinas, √°reas deportivas, grader√≠as, camarines, iluminaci√≥n deportiva\\n- Infraestructura comunitaria: plazas, parques, √°reas verdes, juegos infantiles, mobiliario urbano, bancas, luminarias\\n- Urbanizaci√≥n: loteos, urbanizaciones, habilitaci√≥n de terrenos, movimiento de tierras, explanaciones, nivelaci√≥n\\n- Instalaciones: el√©ctricas, sanitarias, agua potable, alcantarillado, drenaje, aguas lluvias, gas, telecomunicaciones\\n- Arquitectura: dise√±o arquitect√≥nico, proyectos de arquitectura, planos, especificaciones t√©cnicas, estudios de mec√°nica de suelos\\n- Especialidades: estructuras, fundaciones, muros, techumbres, cubiertas, terminaciones, revestimientos, pinturas, cer√°micas, pisos\\n- Accesibilidad: accesibilidad universal, rampas, barandas, se√±al√©tica, demarcaci√≥n, vados peatonales\\n\\nRubros espec√≠ficos identificados:\\n- 72xxxxxx: Servicios de edificaci√≥n, construcci√≥n de instalaciones y mantenimiento\\n- 30xxxxxx: Componentes y suministros estructurales y de construcci√≥n\\n- 76xxxxxx: Servicios de limpieza, descontaminaci√≥n y tratamiento de residuos\\n- 72131700: Construcci√≥n de edificios\\n- 72101900: Acabados de interiores\\n- 30222400: Componentes y sistemas para el techo\\n- 30222700: Estructuras y componentes de edificios' : $('Set Client Data').item.json.sector === 'transporte' ? 'üìö SECTOR: TRANSPORTE Y LOG√çSTICA\\n\\nSin√≥nimos clave:\\n- transporte = traslado = movilizaci√≥n = servicio de transporte = arriendo de veh√≠culos = servicio de movilizaci√≥n\\n\\nT√©rminos aceptados del cat√°logo oficial:\\n- Servicios de transporte: traslado, movilizaci√≥n, conducci√≥n, arriendo, servicios de transporte, transporte privado, transporte p√∫blico, transporte escolar\\n- Tipos de pasajeros: escolares, estudiantes, adultos mayores, personal, funcionarios, trabajadores, pacientes, turistas, visitantes\\n- Modalidades: excursiones, giras, paseos, turismo, transfer, rutas, recorridos, itinerarios, circuitos, tours\\n- Personal: choferes, conductores, pilotos, operadores, despachadores, coordinadores de flota\\n- Veh√≠culos pasajeros: buses, minibuses, furgones, vans, microbuses, colectivos, taxibuses, veh√≠culos, m√≥viles, autom√≥viles\\n- Veh√≠culos carga: camiones, camionetas, furgones de carga, tracto-camiones, remolques, semi-remolques\\n- Log√≠stica: distribuci√≥n, despacho, reparto, entrega, env√≠o, transporte de mercanc√≠as\\n- Carga: mercanc√≠a, fletes, carga, bultos, paquetes, encomiendas, mudanzas, traslado de equipos\\n- Gesti√≥n: administraci√≥n de flotas, control de flota, seguimiento vehicular, GPS, telemetr√≠a, gesti√≥n de rutas\\n- Mantenimiento: mantenci√≥n vehicular, reparaci√≥n, servicio t√©cnico, revisi√≥n t√©cnica, cambio de aceite, neum√°ticos\\n- Combustibles: bencina, petr√≥leo diesel, gas, combustible, abastecimiento, suministro\\n- Seguros: seguros vehiculares, SOAP, p√≥lizas, coberturas\\n\\nRubros espec√≠ficos identificados:\\n- 78101800: Servicios de transporte de pasajeros por carretera\\n- 78111800: Servicios de transporte escolar\\n- 78141500: Servicios de arriendo de veh√≠culos\\n- 25xxxxxx: Veh√≠culos comerciales, militares y particulares\\n- 24xxxxxx: Maquinaria y accesorios para manejo, acondicionamiento y almacenaje de materiales' : 'Por favor selecciona un sector v√°lido en la configuraci√≥n del workflow.' }}"
            },
            {
              "content": "PALABRAS CLAVE DEL CLIENTE:\n{{ $('Set Client Data').item.json.tags }}\n\nLICITACIONES DISPONIBLES:\n{{ $('Format Tenders for LLM').item.json.markdown }}\n\nAnaliza las licitaciones y devuelve los c√≥digos de las que coincidan."
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "temperature": 0.2
        }
      },
      "id": "23ceb63d-eb27-455d-9720-2f5132d78605",
      "name": "Find Matching Tender IDs",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -320,
        -128
      ],
      "credentials": {
        "openAiApi": {
          "id": "omq5BU8Tn3sj3tSp",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extraer IDs de licitaciones coincidentes del primer LLM\nconst items = $input.all();\nconsole.log('=== EXTRAER IDS COINCIDENTES ===');\n\nif (!items || items.length === 0) {\n  console.error('ERROR: No se recibieron items del LLM de IDs');\n  return [{ json: { matching_ids: [], matching_tenders: [], total_tenders: 0 } }];\n}\n\nconst response = items[0].json;\nconsole.log('Response structure:', JSON.stringify(response, null, 2).substring(0, 500));\n\nlet matchingIds = [];\n\n// Extraer matching_ids de la respuesta\nif (response.message && response.message.content) {\n  // Si content es un objeto (jsonOutput: true)\n  if (typeof response.message.content === 'object' && response.message.content.matching_ids) {\n    matchingIds = response.message.content.matching_ids || [];\n    console.log('Extracted matching_ids from object content:', matchingIds);\n  } else if (typeof response.message.content === 'string') {\n    // Si content es string, parsearlo\n    try {\n      const parsed = JSON.parse(response.message.content);\n      matchingIds = parsed.matching_ids || [];\n      console.log('Extracted matching_ids from string content:', matchingIds);\n    } catch (e) {\n      console.error('Error al procesar matching_ids:', e);\n    }\n  }\n} else if (response.matching_ids) {\n  matchingIds = response.matching_ids;\n  console.log('Extracted matching_ids from root:', matchingIds);\n}\n\nconsole.log('IDs coincidentes encontrados:', matchingIds);\nconsole.log('Tipo de matchingIds:', Array.isArray(matchingIds), 'Longitud:', matchingIds.length);\n\n// Obtener datos originales de licitaciones del nodo Formatear para LLM\nconst tenderData = $('Format Tenders for LLM').first().json.tenders || [];\nconsole.log('Total licitaciones originales:', tenderData.length);\n\nif (tenderData.length > 0) {\n  console.log('Primer tender codigo:', tenderData[0].codigo);\n}\n\n// Extraer solo las licitaciones coincidentes (m√°s eficiente que eliminar no coincidentes)\nconst matchingTenders = tenderData.filter(tender => {\n  const matches = matchingIds.includes(tender.codigo);\n  if (matches) {\n    console.log('Match found:', tender.codigo);\n  }\n  return matches;\n});\n\nconsole.log('Licitaciones coincidentes extra√≠das:', matchingTenders.length);\n\nreturn [{\n  json: {\n    matching_ids: matchingIds,\n    matching_tenders: matchingTenders,\n    total_tenders: tenderData.length\n  }\n}];"
      },
      "id": "d7d8222c-c0e8-4bc2-98df-c59fef38fe8d",
      "name": "Filter Matching Tenders",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -48,
        -128
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get all tender items from the filtered results\nconst tenders = $input.all();\n\nconsole.log('=== CONVERT TO HTML TABLE ===');\nconsole.log('Tenders received:', tenders.length);\n\nif (tenders.length > 0) {\n  console.log('First tender structure:', Object.keys(tenders[0].json));\n  console.log('First tender sample:', tenders[0].json);\n}\n\n// Check if we have results\nconst hasResults = tenders.length > 0 && tenders[0].json && tenders[0].json.matching_tenders && tenders[0].json.matching_tenders.length > 0;\nconsole.log('Has valid results:', hasResults);\n\nif (!hasResults) {\n  console.log('INFO: No valid results - returning empty state');\n  return [{\n    json: {\n      htmlTable: null,\n      tenderCount: 0,\n      hasResults: false\n    }\n  }];\n}\n\n// Get the matching tenders from the filter results\nconst matchingTenders = tenders[0].json.matching_tenders || [];\nconsole.log('Matching tenders to process:', matchingTenders.length);\n\n// Helper function to escape HTML\nconst escapeHtml = (str) => {\n  if (!str) return '';\n  return String(str)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n};\n\n// Helper to format currency\nconst formatCurrency = (amount) => {\n  if (!amount && amount !== 0) return 'N/A';\n  return new Intl.NumberFormat('es-CL', {\n    style: 'currency',\n    currency: 'CLP',\n    maximumFractionDigits: 0\n  }).format(amount);\n};\n\n// Build HTML table\nlet tableHtml = `\n<table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; font-family: Arial, sans-serif;\">\n  <thead>\n    <tr style=\"background-color: #f0f0f0;\">\n      <th>C√≥digo</th>\n      <th>Nombre</th>\n      <th>Descripci√≥n</th>\n      <th>Monto Estimado</th>\n      <th>Fecha Publicaci√≥n</th>\n      <th>Fecha Cierre</th>\n      <th>Link</th>\n    </tr>\n  </thead>\n  <tbody>\n`;\n\nmatchingTenders.forEach((tender) => {\n  tableHtml += `\n    <tr>\n      <td>${escapeHtml(tender.codigo)}</td>\n      <td>${escapeHtml(tender.nombre)}</td>\n      <td>${escapeHtml(tender.descripcion)}</td>\n      <td>${formatCurrency(tender.monto_estimado)}</td>\n      <td>${escapeHtml(tender.fecha_publicacion)}</td>\n      <td>${escapeHtml(tender.fecha_cierre)}</td>\n      <td><a href=\"${escapeHtml(tender.link)}\" target=\"_blank\">Ver licitaci√≥n</a></td>\n    </tr>\n  `;\n});\n\ntableHtml += `\n  </tbody>\n</table>\n`;\n\nconsole.log('SUCCESS: Generated HTML table with', matchingTenders.length, 'rows');\n\nreturn [{\n  json: {\n    htmlTable: tableHtml,\n    tenderCount: matchingTenders.length,\n    hasResults: true\n  }\n}];"
      },
      "id": "237dbe6f-8a1a-4dc1-bcfc-53c8bb7f4404",
      "name": "Convert to HTML Table",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        96,
        -128
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get client data and HTML table\nconst clientData = $('Set Client Data').first().json;\nconst tableData = $input.first().json;\n\nconsole.log('=== COMPOSE EMAIL ===');\nconsole.log('Table data received:', tableData);\n\nconst companyName = clientData.companyName || 'Estimado cliente';\nconst companyEmail = clientData.companyEmail || '';\nconst tenderCount = tableData.tenderCount || 0;\nconst hasResults = tableData.hasResults !== false;\n\nconsole.log('Company:', companyName);\nconsole.log('Email:', companyEmail);\nconsole.log('Tender count:', tenderCount);\nconsole.log('Has results:', hasResults);\n\n// Compose email\nconst subject = `Licitaciones recomendadas para ${companyName}`;\n\nlet htmlBody;\nlet textBody;\n\nif (!hasResults || tenderCount === 0) {\n  console.log('INFO: Composing NO RESULTS email');\n  // No results - simple message\n  htmlBody = `\n<div style=\"font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto;\">\n  <h2>Hola ${companyName},</h2>\n  \n  <p>Le informamos que en esta oportunidad no hemos encontrado licitaciones que se ajusten a los criterios de b√∫squeda de su empresa.</p>\n  \n  <p>Seguiremos monitoreando las publicaciones y le avisaremos cuando encontremos oportunidades relevantes.</p>\n  \n  <br>\n  <p>Saludos cordiales,<br>\n  <strong>ACME Consulting</strong></p>\n</div>\n`;\n\n  textBody = `\nHola ${companyName},\n\nLe informamos que en esta oportunidad no hemos encontrado licitaciones que se ajusten a los criterios de b√∫squeda de su empresa.\n\nSeguiremos monitoreando las publicaciones y le avisaremos cuando encontremos oportunidades relevantes.\n\nSaludos cordiales,\nACME Consulting\n`;\n} else {\n  console.log('INFO: Composing email WITH RESULTS');\n  // With results - show table\n  const htmlTable = tableData.htmlTable;\n  console.log('HTML table length:', htmlTable ? htmlTable.length : 0);\n  \n  htmlBody = `\n<div style=\"font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto;\">\n  <h2>Hola ${companyName},</h2>\n  \n  <p>Le informamos que hemos encontrado <strong>${tenderCount} ${tenderCount === 1 ? 'licitaci√≥n' : 'licitaciones'}</strong> que recomendamos para su empresa:</p>\n  \n  ${htmlTable}\n  \n  <br>\n  <p>Saludos cordiales,<br>\n  <strong>ACME Consulting</strong></p>\n</div>\n`;\n\n  textBody = `\nHola ${companyName},\n\nLe informamos que hemos encontrado ${tenderCount} ${tenderCount === 1 ? 'licitaci√≥n' : 'licitaciones'} que recomendamos para su empresa.\n\nPara ver los detalles, por favor revise el correo en formato HTML.\n\nSaludos cordiales,\nACME Consulting\n`;\n}\n\nconsole.log('Email composed - HTML body length:', htmlBody.length);\nconsole.log('Subject:', subject);\n\nreturn [{\n  json: {\n    to: companyEmail,\n    subject: subject,\n    html: htmlBody,\n    text: textBody\n  }\n}];"
      },
      "id": "6501b4d1-9183-4573-a6aa-6043995e8053",
      "name": "Compose Email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        -128
      ]
    },
    {
      "parameters": {
        "fromEmail": "eduardo@attitude.cl",
        "toEmail": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "emailFormat": "both",
        "text": "={{ $json.text }}",
        "html": "={{ $json.html }}",
        "options": {}
      },
      "id": "5ed1ff87-d762-45d9-9f72-607fbb3f5dcb",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        384,
        -128
      ],
      "webhookId": "5ea5e3e7-3519-44ec-9438-d58fc149a267",
      "credentials": {
        "smtp": {
          "id": "UB4BWxwhDGzwlgTr",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse ruburos from comma-separated string to array\nconst items = $input.all();\n\nconsole.log('=== PARSE RUBUROS ===');\nconsole.log('Items received:', items.length);\n\nif (!items || items.length === 0) {\n  console.log('No items received, returning empty rubros array');\n  return [{\n    json: {\n      rubros: []\n    }\n  }];\n}\n\nconst clientData = items[0].json;\nconsole.log('Client data:', clientData);\n\n// Parse ruburos if present\nlet rubros = [];\nif (clientData.ruburos && typeof clientData.ruburos === 'string') {\n  // Remove spaces and split by comma\n  rubros = clientData.ruburos\n    .split(',')\n    .map(r => r.trim())\n    .filter(r => r !== '' && /^\\d+$/.test(r)); // Only keep numeric codes\n  \n  console.log('Parsed rubros:', rubros);\n  console.log('Rubros count:', rubros.length);\n} else {\n  console.log('No ruburos found or invalid format');\n}\n\n// Return the same data but with parsed rubros as array\nreturn [{\n  json: {\n    ...clientData,\n    rubros: rubros\n  }\n}];"
      },
      "id": "be6e21cd-ccd3-446e-b986-3121978ac22e",
      "name": "Parse Rubros",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        -128
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking 'Execute workflow'": {
      "main": [
        [
          {
            "node": "Set Client Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Client Data": {
      "main": [
        [
          {
            "node": "Parse Rubros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Tenders": {
      "main": [
        [
          {
            "node": "Format Tenders for LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Tenders for LLM": {
      "main": [
        [
          {
            "node": "Find Matching Tender IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Matching Tender IDs": {
      "main": [
        [
          {
            "node": "Filter Matching Tenders",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Matching Tenders": {
      "main": [
        [
          {
            "node": "Convert to HTML Table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to HTML Table": {
      "main": [
        [
          {
            "node": "Compose Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compose Email": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Rubros": {
      "main": [
        [
          {
            "node": "Search Tenders",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "6673b619-9437-458d-864f-7adbdda5c59d",
  "meta": {
    "instanceId": "c4d6fe24465d4cccbc0cf10ead0f9debe8c95c1bfcff090b3524c815bff1e4ef"
  },
  "id": "LC96x3FSUEkiq2WA",
  "tags": []
}